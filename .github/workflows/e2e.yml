name: E2E Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  e2e-tests:
    name: E2E Discovery + Upload
    runs-on: ubuntu-latest
    permissions:
      contents: read


    services:
      rustfs:
        image: rustfs/rustfs:latest
        ports:
          - 9000:9000
          - 9001:9001

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install protobuf compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Cache Cargo dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: backend

      - name: Setup Temporal
        uses: temporalio/setup-temporal@v0
        with:
          version: latest

      - name: Start Temporal Server
        run: |
          temporal server start-dev --headless &

          echo "Waiting for Temporal server to start..."
          for i in {1..30}; do
            if temporal operator cluster health 2>/dev/null; then
              echo "Temporal server is ready"
              break
            fi
            echo "Waiting for Temporal server... ($i/30)"
            sleep 2
          done

          temporal operator cluster health

      - name: Prepare SQLite database
        working-directory: ./backend
        run: rm -f /tmp/skillregistry-e2e.db

      - name: Run setup (migrations + S3 bucket)
        working-directory: ./backend
        env:
          SKILLREGISTRY_DATABASE__URL: sqlite:///tmp/skillregistry-e2e.db?mode=rwc
          SKILLREGISTRY_GITHUB__TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKILLREGISTRY_GITHUB__SEARCH_KEYWORDS: repo:anthropics/skills
          SKILLREGISTRY_S3__ENDPOINT: http://localhost:9000
          SKILLREGISTRY_S3__BUCKET: skills
          SKILLREGISTRY_S3__REGION: us-east-1
          SKILLREGISTRY_S3__FORCE_PATH_STYLE: "true"
          SKILLREGISTRY_S3__ACCESS_KEY_ID: rustfsadmin
          SKILLREGISTRY_S3__SECRET_ACCESS_KEY: rustfsadmin
          SKILLREGISTRY_TEMPORAL__SERVER_URL: http://localhost:7233
          SKILLREGISTRY_SETUP_SKIP_TEMPORAL: "true"
          RUST_LOG: info
        run: cargo run --bin setup

      - name: Start Worker
        working-directory: ./backend
        env:
          SKILLREGISTRY_DATABASE__URL: sqlite:///tmp/skillregistry-e2e.db?mode=rwc
          SKILLREGISTRY_GITHUB__TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKILLREGISTRY_GITHUB__SEARCH_KEYWORDS: repo:anthropics/skills
          SKILLREGISTRY_S3__ENDPOINT: http://localhost:9000
          SKILLREGISTRY_S3__BUCKET: skills
          SKILLREGISTRY_S3__REGION: us-east-1
          SKILLREGISTRY_S3__FORCE_PATH_STYLE: "true"
          SKILLREGISTRY_S3__ACCESS_KEY_ID: rustfsadmin
          SKILLREGISTRY_S3__SECRET_ACCESS_KEY: rustfsadmin
          SKILLREGISTRY_TEMPORAL__SERVER_URL: http://localhost:7233
          SKILLREGISTRY_TEMPORAL__TASK_QUEUE: skill-registry-queue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUST_LOG: info
        run: |
          cargo run --bin worker > /tmp/worker.log 2>&1 &
          WORKER_PID=$!
          echo "$WORKER_PID" > /tmp/worker.pid
          sleep 8

      - name: Run E2E test (discovery + upload)
        working-directory: ./backend
        env:
          SKILLREGISTRY_DATABASE__URL: sqlite:///tmp/skillregistry-e2e.db?mode=rwc
          SKILLREGISTRY_TEMPORAL__SERVER_URL: http://localhost:7233
          SKILLREGISTRY_TEMPORAL__TASK_QUEUE: skill-registry-queue
          SKILLREGISTRY_S3__ENDPOINT: http://localhost:9000
          SKILLREGISTRY_S3__BUCKET: skills
          SKILLREGISTRY_S3__REGION: us-east-1
          SKILLREGISTRY_S3__FORCE_PATH_STYLE: "true"
          SKILLREGISTRY_S3__ACCESS_KEY_ID: rustfsadmin
          SKILLREGISTRY_S3__SECRET_ACCESS_KEY: rustfsadmin
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          E2E_DISCOVERY_QUERY: repo:anthropics/skills
          E2E_TARGET_OWNER: anthropics
          E2E_TARGET_REPO: skills
          E2E_DISCOVERY_TIMEOUT_SECS: "360"
          E2E_SYNC_TIMEOUT_SECS: "600"
          RUST_LOG: debug
        run: |
          cargo test -p e2e-tests --test e2e test_discovery_sync_and_upload -- --ignored --nocapture

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/worker.pid ]; then
            kill "$(cat /tmp/worker.pid)" || true
          fi

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs
          path: |
            /tmp/worker.log
            /tmp/skillregistry-e2e.db
